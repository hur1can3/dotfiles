#!/bin/bash
#
# pbrisbin 2009
#
# http://pbrisbin.com:8080/bin/retrieve
#
#
###

message() {
  echo "usage: retrieve (-m) [file_or_directory]"
  echo 
  echo "      retrieve from daily backup"
  echo "  -m  retrieve from monthly backup"
  echo
  echo
  exit 1
}

errorout() {
  echo "error: $1"
  exit 1
}

rel2abs() {
  local file="$(basename "$1")"
  local dir="$(dirname "$1")"

  pushd "${dir:-./}" &>/dev/null || exit 1
  dir="$PWD"; popd &>/dev/null

  echo "$dir/$file"
}

CONF='/home/patrick/.config/backup.conf'
[ -f "$CONF" ] && . "$CONF" || errorout "config $CONF not found"

SRC="$BACKUP_DAILY"

case "$1" in
  -m) SRC="$BACKUP_MONTHLY" ; shift ;;
  *)  message                       ;;
esac

# first, make an absolute path
dst="$(rel2abs "$1")"

# then, remove leading / or /home
case "$dst" in
  /home*) src="$SRC/${dst/\/home\//}" ;;
  *)      src="$SRC/${dst/\//}"       ;;
esac

# do we have a backup file?
[ ! -e "$src" ] && errorout "$src: file not found"

# don't clobber without prompting
if [ -e "$dst" ]; then
  echo -n "$dst exists, overwrite? [Y/n] " && read A

  [ "$A" = "y" -o -z "$A" ] || exit 1

  # needed only if replacing an existing dir
  [ -d "$src" ] && dst="$(dirname "$dst")"
fi

cp -av "$src" "$dst" || errorout "retrieval failed"
