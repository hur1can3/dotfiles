#!/bin/bash
#
# http://pbrisbin.com:8080/bin/playnow
#
# allows playing of any file or files through
# mpd without actually adding them to your
# collection
#
# bash expansion works well too:
#
#  playnow ./some_dir/*
#
# a bit useless now that i hear mpd supports
# file://whatever... oh well
#
###

message() {
  echo 'usage: playnow [file1] [file2] ...'
  echo
  exit 1
}

# relative path -> absolute path
rel2abs() {
  local file="$(basename "$1")"
  local dir="$(dirname "$1")"

  pushd "${dir:-./}" &>/dev/null || exit 1
  dir="$PWD"
  popd &>/dev/null

  echo "$dir/$file"
}

get_mdir() {
  local mdir="$(awk -F '"' '/^music_directory/ {print $2}' /etc/mpd.conf)"

  # a literal ~ will cause problems
  echo "${mdir/\~/$HOME}"
}

clean_temp() { [ -d "$1" ] && rm -r "$1"; mkdir "$1"; }

link_files() { [ ! -L "$2" ] && ln -s "$1" "$2"; }

update_and_add() {
  mpc --wait --no-status update "$1" >/dev/null || return 1
  mpc --no-status add "$1" >/dev/null && return 0 || return 1
}

# find out musid dir and set temp dir
mdir="$(get_mdir)"; temp="$mdir/temp"

# don't clear temp if files are in playlist now
mpc playlist --format %file% | grep -q "^${temp/$mdir\//}" || clean_temp "$temp"

# get current length
N=$(mpc playlist | wc -l)

# link files
for file in "$@"; do 
  link_files "$(rel2abs "$file")" "$temp/$(basename "$file")"
done

# add them and play prev length + 1
update_and_add "${temp/$mdir\//}" && mpc play $((N+1)) >/dev/null
